(function(h){var d=h.videosketch||(h.videosketch={}),a=h.document,b;d.util={};d.util.slice=[].slice;b={bind:function(c,e){this.eventMap=this.eventMap||{};this.eventMap[c]=this.eventMap[c]||[];this.eventMap[c].push(e)},unbind:function(c,e){this.eventMap[c].splice(this.eventMap[c].indexOf(e),1)},trigger:function(c){var e=d.util.slice.call(arguments,1);this.eventMap&&this.eventMap[c]&&this.eventMap[c].forEach(function(f){f.apply(this,e)})}};d.util.makeElement=function(c,e){var f=a.createElement(c),g;
for(g in e)if(g==="class")f.className=e[g];else f.setAttribute(g,e[g]);return f};d.util.delegate=function(c,e,f,g){c.addEventListener(f,function(j){for(var i=j.target,k=d.util.slice.call(c.querySelectorAll(e));i&&k.indexOf(i)<0;)i=i.parentNode;i&&i!==c&&i!==a&&g.call(i,j)},false)};d.util.localCoordinates=function(c,e){var f;e=e||c.target;f=e.getBoundingClientRect();return{x:Math.max(0,Math.min(1,(c.clientX-f.left)/f.width)),y:Math.max(0,Math.min(1,(c.clientY-f.top)/f.height)),box:f}};d.util.makeEventSource=
function(c){c=c=c.prototype||c;var e;for(e in b)if(b.hasOwnProperty(e))c[e]=b[e]};Function.prototype.bind=Function.prototype.bind||function(c){var e=this,f=d.util.slice.call(arguments,1);return function(){return e.apply(c,f.concat(d.util.slice.call(arguments)))}};if(Object.prototype.__defineGetter__&&!Object.defineProperty)Object.defineProperty=function(c,e,f){"get"in f&&c.__defineGetter__(e,f.get);"set"in f&&c.__defineSetter__(e,f.set)};typeof Element!=="undefined"&&!Element.hasOwnProperty.call(Element.prototype,
"classList")&&function(){var c=function(f){return RegExp("(^|\\s)"+f+"(\\s|$)")},e=function(f){this.element=f};e.prototype={contains:function(f){return c(f).test(this.element.className)},add:function(f){this.contains(f)||(this.element.className+=(this.element.className?" ":"")+f)},remove:function(f){this.element.className=this.element.className.replace(c(f)," ").trim()},toggle:function(f){var g=c(f);if(g.test(this.element.className))this.element.className=this.element.className.replace(g," ").trim();
else this.element.className+=(this.element.className?" ":"")+f}};Object.defineProperty(Element.prototype,"classList",{get:function(){return new e(this)}})}()})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Editor=function(a,b){this.glint=b;var c=document.createDocumentFragment();this.video=a.play?a:document.querySelector(a);this.container=this.video.parentNode;this.container.classList.add("vs-container");this.container.style.width=this.video.width+"px";this.container.style.height=this.video.height+"px";this.editSketch=this.editSketch.bind(this);this.removeSketch=this.removeSketch.bind(this);this.sketches=[];this.sketchpad=new d.Renderer({"class":"vs-sketchpad",
parent:c});this.thumbnails=d.util.makeElement("ul",{"class":"vs-thumbnails"});c.appendChild(this.thumbnails);this.controls=d.util.makeElement("div",{"class":"vs-controls"});this.pencilControl=d.util.makeElement("button",{"class":"vs-pencil-control",title:"Pencil tool"});this.controls.appendChild(this.pencilControl);this.pencilStyles=d.util.makeElement("div",{"class":"vs-pencil-styles"});this.controls.appendChild(this.pencilStyles);d.Path.styles.forEach(function(e){this.pencilStyles.appendChild(d.util.makeElement("div",
{"class":e.isDefault?"selected":"",title:e.label,"data-group":e.group,"data-value":e.value}))},this);this.eraserControl=d.util.makeElement("button",{"class":"vs-eraser-control",title:"Eraser tool"});this.controls.appendChild(this.eraserControl);this.clearControl=d.util.makeElement("button",{"class":"vs-clear-control",title:"Clear this sketch"});this.controls.appendChild(this.clearControl);this.showThumbsControl=d.util.makeElement("button",{"class":"vs-show-thumbnails-control",title:"Show all sketches"});
this.controls.appendChild(this.showThumbsControl);c.appendChild(this.controls);this.video.nextSibling?this.container.insertBefore(c,this.video.nextSibling):this.container.appendChild(c);this.inactive=true;this.video.readyState>0&&this.sketchpad.setAspectRatio(this.video.videoWidth/this.video.videoHeight,true);this.video.addEventListener("loadedmetadata",this.onVideoMetaDataLoaded.bind(this),false);this.video.addEventListener("play",this.onVideoPlay.bind(this),false);this.video.addEventListener("seeking",
this.onVideoSeeking.bind(this),false);h.addEventListener("resize",this.onWindowResize.bind(this),false);this.pencilControl.addEventListener("click",this.onPencilControlClick.bind(this),false);this.video.addEventListener("click",this.onPencilControlClick.bind(this),false);this.eraserControl.addEventListener("click",this.onEraserControlClick.bind(this),false);this.clearControl.addEventListener("click",this.onClearControlClick.bind(this),false);this.showThumbsControl.addEventListener("click",this.onShowThumbsControlClick.bind(this),
false);d.util.delegate(this.pencilStyles,"div","click",this.onPencilStylesClickDelegate.bind(this));this.onSketchPadMouseMove=this.onSketchPadMouseMove.bind(this);this.onSketchPadMouseOver=this.onSketchPadMouseOver.bind(this);this.onDocumentMouseUp=this.onDocumentMouseUp.bind(this);this.sketchpad.container.addEventListener("mousedown",this.onSketchPadMouseDown.bind(this),false);this.sketchpad.container.addEventListener("contextmenu",this.onSketchPadContextMenu,false)};d.Editor.prototype={createSketch:function(){var a=
new d.Sketch(this.video);this.sketches.push(a);this.createThumbnailFromSketch(a);this.editSketch(a)},editSketch:function(a){this.video.pause();this.seekingFrame=true;try{this.video.currentTime=a.timestamp}catch(b){}this.sketchpad.attachSketch(a);this.sketch=a;if(this.inactive){this.drawing=true;this.glint&&this.glint.showNotice()}},removeSketch:function(a){this.sketches.splice(this.sketches.indexOf(a),1);if(this.sketchpad.detachSketch(a)){this.inactive=true;delete this.sketch}this.sketches.length||
this.container.classList.remove("vs-showing-thumbnails")},createThumbnailFromSketch:function(a){a=new d.Thumbnail({parent:this.thumbnails,sketch:a,aspectRatio:this.video.videoWidth/this.video.videoHeight});a.bind("select",this.editSketch);a.bind("remove",this.removeSketch)},getPencilStyles:function(){var a=this.pencilStyles.querySelector('.selected[data-group="color"]'),b=this.pencilStyles.querySelector('.selected[data-group="width"]');return{color:a.getAttribute("data-value"),width:parseInt(b.getAttribute("data-value"),
10)}},onVideoMetaDataLoaded:function(){this.sketchpad.setAspectRatio(this.video.videoWidth/this.video.videoHeight,true)},onVideoPlay:function(){this.inactive=true},onVideoSeeking:function(){if(!this.seekingFrame)this.inactive=true;this.seekingFrame=false},onWindowResize:function(){this.video.readyState>0&&setTimeout(this.sketchpad.resizeAndCenter,0)},onPencilControlClick:function(){if(this.inactive){this.video.pause();this.createSketch()}else if(this.erasing){this.drawing=true;this.glint&&this.glint.showNotice()}},
onEraserControlClick:function(){this.erasing=this.erasing||this.drawing;this.glint&&this.erasing&&this.glint.showNotice()},onClearControlClick:function(){this.sketch.clear()},onShowThumbsControlClick:function(){this.container.classList.toggle("vs-showing-thumbnails")},onPencilStylesClickDelegate:function(a){a=a.target;this.pencilStyles.querySelector('.selected[data-group="'+a.getAttribute("data-group")+'"]').classList.remove("selected");a.classList.add("selected")},onSketchPadMouseDown:function(a){var b=
d.util.localCoordinates(a),c=a.which===3;this.mouseDown=true;a.preventDefault();this.erasing=this.erasing||this.drawing&&c;if(this.drawing){this.sketch.createPath(this.getPencilStyles());this.sketch.addPointToLastPath(b)}else this.erasing&&this.sketch.removePathsCloseToPoints(b);this.lastLocalCoordinates=b;document.addEventListener("mouseup",this.onDocumentMouseUp,false);this.sketchpad.container.addEventListener("mousemove",this.onSketchPadMouseMove,false);this.sketchpad.container.addEventListener("mouseover",
this.onSketchPadMouseOver,false)},onSketchPadMouseMove:function(a){a=d.util.localCoordinates(a);if(this.drawing)this.sketch.addPointToLastPath(a);else this.erasing&&this.sketch.removePathsCloseToPoints(a,this.lastLocalCoordinates);this.lastLocalCoordinates=a},onSketchPadMouseOver:function(a){a=d.util.localCoordinates(a);if(this.drawing){this.sketch.createPath(this.getPencilStyles());this.sketch.addPointToLastPath(a)}this.localCoordinates=a},onDocumentMouseUp:function(a){this.mouseDown=false;a.preventDefault();
this.drawing=this.drawing||this.erasing&&a.which===3;this.sketchpad.renderPaths();document.removeEventListener("mouseup",this.onDocumentMouseUp,false);this.sketchpad.container.removeEventListener("mousemove",this.onSketchPadMouseMove,false);this.sketchpad.container.removeEventListener("mouseover",this.onSketchPadMouseOver,false)},onSketchPadContextMenu:function(a){a.preventDefault()}};d.Editor.states=["drawing","erasing","inactive"];d.Editor.states.forEach(function(a){Object.defineProperty(d.Editor.prototype,
a,{get:function(){return this.state===a},set:function(b){if(b){this.container.classList.remove("vs-"+this.state);this.container.classList.add("vs-"+a);this.state=a}else if(this.state===a)this.inactive=true}})});d.setup=function(a,b){return new d.Editor(a,b)}})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Path=function(a){this.points=[];this.color=a.color;this.width=a.width};d.Path.prototype={addPoint:function(a){this.points.push(a);return this},isCloseToPoints:function(a,b){var c=this.points.length,e,f;if(this.points.length===1)return d.Path.pointDistance(this.points[0],a)<0.02;for(;(e=this.points[--c])&&(f=this.points[c-1]);)if(d.Path.pointDistance(e,a)<0.02)return true;else if(b&&d.Path.segmentsIntersect(a,b,e,f))return true;return false}};
d.util.makeEventSource(d.Path);d.Path.pointDistance=function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))};d.Path.segmentsIntersect=function(a,b,c,e){var f,g;f=(a.x-b.x)*(e.y-b.y)-(a.y-b.y)*(e.x-b.x);f/=(a.y-b.y)*(c.x-e.x)-(a.x-b.x)*(c.y-e.y);g=(c.x-e.x)*(e.y-b.y)-(c.y-e.y)*(e.x-b.x);g/=(a.y-b.y)*(c.x-e.x)-(a.x-b.x)*(c.y-e.y);return f>=0&&f<=1&&g>=0&&g<=1};d.Path.styles=[];d.Path.styles.push({group:"color",label:"White",value:"#fff",isDefault:true});d.Path.styles.push({group:"color",
label:"Red",value:"#ff0000"});d.Path.styles.push({group:"width",label:"Thick",value:12,isDefault:true});d.Path.styles.push({group:"width",label:"Thin",value:4})})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Sketch=function(a){this.paths=[];if(a){this.timestamp=a.currentTime;this.capture(a)}};d.Sketch.prototype={capture:function(a){this.timestamp=a.currentTime;this.frame=d.util.makeElement("canvas");this.frame.width=a.videoWidth;this.frame.height=a.videoHeight;this.frame.getContext("2d").drawImage(a,0,0)},createPath:function(a){this.lastPath=new d.Path(a);this.paths.push(this.lastPath);return this.lastPath},addPointToLastPath:function(a){this.lastPath.addPoint(a);
this.trigger("pathaddpoint",this.lastPath,a)},removePathsCloseToPoints:function(a,b){for(var c=[],e=this.paths.length,f;f=this.paths[--e];)f.isCloseToPoints(a,b)||c.push(f);if(c.length!==this.paths.length){this.paths=c;this.trigger("pathremove")}},clear:function(){this.paths=[];this.trigger("pathremove")}};d.util.makeEventSource(d.Sketch)})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Renderer=function(a){this.renderFrame=this.renderFrame.bind(this);this.renderPaths=this.renderPaths.bind(this);this.renderPathPoint=this.renderPathPoint.bind(this);this.container=d.util.makeElement("div",{"class":a["class"]||"vs-renderer"});this.backCanvas=d.util.makeElement("canvas",{"class":"vs-back-canvas"});this.container.appendChild(this.backCanvas);this.frontCanvas=d.util.makeElement("canvas",{"class":"vs-front-canvas"});this.container.appendChild(this.frontCanvas);
a.parent.appendChild(this.container);this.frontContext=this.frontCanvas.getContext("2d");d.Renderer.normalizeContext(this.frontContext);this.backContext=this.backCanvas.getContext("2d");this.setCanvasSize(a.width||300,a.height||150);a.sketch&&this.attachSketch(a.sketch)};d.Renderer.prototype={setCanvasSize:function(a,b){this.frontCanvas.width=this.backCanvas.width=this.width=parseInt(a,10);this.frontCanvas.height=this.backCanvas.height=this.height=parseInt(b,10);d.Renderer.normalizeContext(this.frontContext);
this.sketch&&this.renderAll()},setContainerSize:function(a,b){this.container.style.width=a+"px";this.container.style.height=b+"px"},setContainerOffset:function(a,b){this.container.style.left=a+"px";this.container.style.top=b+"px"},attachSketch:function(a){this.sketch&&this.detachSketch(this.sketch);this.sketch=a;this.sketch.bind("pathremove",this.renderPaths);this.sketch.bind("pathaddpoint",this.renderPathPoint);this.renderAll()},detachSketch:function(a){var b=false;if(a===this.sketch){this.sketch.unbind("pathremove",
this.renderPaths);this.sketch.unbind("pathaddpoint",this.renderPathPoint);delete this.sketch;b=true}return b},renderAll:function(){this.renderPaths();this.renderFrame()},renderFrame:function(){var a=this.sketch.frame;try{this.backContext.drawImage(a,0,0,a.width,a.height,0,0,this.width,this.height)}catch(b){}},renderPaths:function(){this.clear();this.sketch&&this.sketch.paths&&this.sketch.paths.forEach(this.renderPath,this)},renderPath:function(a){var b=a.points,c=b.length,e=d.Renderer.getControlPoints,
f=0,g;this.setPathStyle(a);if(a.points.length<3)this.renderPathPoint(a,b[c-1]);else{this.frontContext.beginPath();a=b[0];this.frontContext.normalizedMoveTo(a.x,a.y);for(f=1;f<c-1;f++){a=b[f];g=e(b[f-1],a,b[f+1]);this.frontContext.normalizedQuadraticCurveTo(g.p1.x,g.p1.y,a.x,a.y)}this.frontContext.normalizedQuadraticCurveTo(g.p2.x,g.p2.y,b[c-1].x,b[c-1].y);this.frontContext.stroke()}},renderPathPoint:function(a,b){var c=a.points[a.points.indexOf(b)-1]||{x:b.x*1.001,y:b.y*1.001};this.setPathStyle(a);
this.frontContext.beginPath();this.frontContext.normalizedMoveTo(c.x,c.y);this.frontContext.normalizedLineTo(b.x,b.y);this.frontContext.stroke()},setPathStyle:function(a){this.frontContext.strokeStyle=a.color||"#fff";this.frontContext.lineWidth=a.width/1E3*this.frontCanvas.width;this.frontContext.lineCap="round";this.frontContext.lineJoin="round"},clear:function(){this.frontContext.clearRect(0,0,this.frontCanvas.width,this.frontCanvas.height)},setAspectRatio:function(a,b){if(this.container&&this.container.nodeType){var c;
this.aspectRatio=a;if(b){this.resizeAndCenter=this.resizeAndCenter.bind(this);this.resizeAndCenter()}else{c=d.util.makeElement("img");c.src=d.util.makeElement("canvas",{width:800,height:parseInt(800/a,10)}).toDataURL();this.container.appendChild(c)}}},resizeAndCenter:function(){if(!(!this.container||!this.container.nodeType||!this.container.parentNode)){var a=this.container.parentNode.getBoundingClientRect(),b={top:0,left:0,width:0,height:0};if(this.aspectRatio>a.width/a.height){b.top=(a.height-a.width/
this.aspectRatio)/2;b.width=a.width;b.height=a.width/this.aspectRatio}else{b.left=(a.width-a.height*this.aspectRatio)/2;b.width=a.height*this.aspectRatio;b.height=a.height}this.setCanvasSize(b.width,b.height);this.setContainerSize(b.width,b.height);this.setContainerOffset(b.left,b.top)}}};d.Renderer.normalizeContext=function(a){var b=a.canvas.width,c=a.canvas.height;a.normalizedMoveTo=function(e,f){a.moveTo(e*b,f*c)};a.normalizedLineTo=function(e,f){a.lineTo(e*b,f*c)};a.normalizedQuadraticCurveTo=
function(e,f,g,j){a.quadraticCurveTo(e*b,f*c,g*b,j*c)}};d.Renderer.getControlPoints=function(a,b,c){var e=Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2)),f=Math.sqrt(Math.pow(c.x-b.x,2)+Math.pow(c.y-b.y,2)),g=0.5*e/(e+f);e=0.5*f/(e+f);return{p1:{x:b.x-g*(c.x-a.x),y:b.y-g*(c.y-a.y)},p2:{x:b.x+e*(c.x-a.x),y:b.y+e*(c.y-a.y)}}}})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Thumbnail=function(a){this.parent=a.parent;this.container=d.util.makeElement("li",{"class":"vs-thumbnail selected"});this.select();this.sketchpad=new d.Renderer({parent:this.container,width:300,height:parseInt(300/a.aspectRatio,10),sketch:a.sketch});this.sketchpad.setAspectRatio(a.aspectRatio);this.removeControl=d.util.makeElement("button",{"class":"vs-remove-control",title:"Remove this sketch"});this.container.appendChild(this.removeControl);
this.parent.appendChild(this.container);this.container.addEventListener("click",this.onContainerClick.bind(this),false);this.removeControl.addEventListener("click",this.onRemoveControlClick.bind(this),false)};d.Thumbnail.prototype={onContainerClick:function(){this.select();this.trigger("select",this.sketchpad.sketch)},onRemoveControlClick:function(a){a.stopPropagation();this.remove();this.trigger("remove",this.sketchpad.sketch)},select:function(){var a=this.parent.querySelector(".vs-thumbnail.selected");
a&&a.classList.remove("selected");this.container.classList.add("selected")},remove:function(){this.sketchpad.detachSketch();this.parent.removeChild(this.container)}};d.util.makeEventSource(d.Thumbnail)})(this);