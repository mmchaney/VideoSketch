(function(h){var d=h.videosketch||(h.videosketch={}),a=h.document,b;d.util={};d.util.slice=[].slice;b={bind:function(c,f){this.eventMap=this.eventMap||{};this.eventMap[c]=this.eventMap[c]||[];this.eventMap[c].push(f)},unbind:function(c,f){this.eventMap[c].splice(this.eventMap[c].indexOf(f),1)},trigger:function(c){var f=d.util.slice.call(arguments,1);this.eventMap&&this.eventMap[c]&&this.eventMap[c].forEach(function(e){e.apply(this,f)})}};d.util.makeElement=function(c,f){var e=a.createElement(c),g;
for(g in f)if(g==="class")e.className=f[g];else e.setAttribute(g,f[g]);return e};d.util.delegate=function(c,f,e,g){c.addEventListener(e,function(j){for(var i=j.target,k=d.util.slice.call(c.querySelectorAll(f));i&&k.indexOf(i)<0;)i=i.parentNode;i&&i!==c&&i!==a&&g.call(i,j)},false)};d.util.localCoordinates=function(c,f){var e;f=f||c.target;e=f.getBoundingClientRect();return{x:Math.max(0,Math.min(1,(c.clientX-e.left)/e.width)),y:Math.max(0,Math.min(1,(c.clientY-e.top)/e.height)),box:e}};d.util.makeEventSource=
function(c){c=c=c.prototype||c;var f;for(f in b)if(b.hasOwnProperty(f))c[f]=b[f]};Function.prototype.bind=Function.prototype.bind||function(c){var f=this,e=d.util.slice.call(arguments,1);return function(){return f.apply(c,e.concat(d.util.slice.call(arguments)))}};if(Object.prototype.__defineGetter__&&!Object.defineProperty)Object.defineProperty=function(c,f,e){"get"in e&&c.__defineGetter__(f,e.get);"set"in e&&c.__defineSetter__(f,e.set)};typeof Element!=="undefined"&&!Element.hasOwnProperty.call(Element.prototype,
"classList")&&function(){var c=function(e){return RegExp("(^|\\s)"+e+"(\\s|$)")},f=function(e){this.element=e};f.prototype={contains:function(e){return c(e).test(this.element.className)},add:function(e){this.contains(e)||(this.element.className+=(this.element.className?" ":"")+e)},remove:function(e){this.element.className=this.element.className.replace(c(e)," ").trim()},toggle:function(e){var g=c(e);if(g.test(this.element.className))this.element.className=this.element.className.replace(g," ").trim();
else this.element.className+=(this.element.className?" ":"")+e}};Object.defineProperty(Element.prototype,"classList",{get:function(){return new f(this)}})}()})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Editor=function(a){var b=document.createDocumentFragment();this.video=a.play?a:document.querySelector(a);this.container=this.video.parentNode;this.container.tabIndex=this.container.tabindex||-1;this.container.classList.add("vs-container");this.container.style.width=this.video.width+"px";this.container.style.height=this.video.height+"px";this.editSketch=this.editSketch.bind(this);this.removeSketch=this.removeSketch.bind(this);this.sketches=[];
this.sketchpad=new d.Renderer({"class":"vs-sketchpad",parent:b});this.thumbnails=d.util.makeElement("ul",{"class":"vs-thumbnails"});b.appendChild(this.thumbnails);this.controls=d.util.makeElement("div",{"class":"vs-controls"});this.pencilControl=d.util.makeElement("button",{"class":"vs-pencil-control",title:"Pencil tool"});this.controls.appendChild(this.pencilControl);this.pencilStyles=d.util.makeElement("div",{"class":"vs-pencil-styles"});this.controls.appendChild(this.pencilStyles);d.Path.styles.forEach(function(c){this.pencilStyles.appendChild(d.util.makeElement("div",
{"class":c.isDefault?"selected":"",title:c.label,"data-group":c.group,"data-value":c.value}))},this);this.eraserControl=d.util.makeElement("button",{"class":"vs-eraser-control",title:"Eraser tool"});this.controls.appendChild(this.eraserControl);this.clearControl=d.util.makeElement("button",{"class":"vs-clear-control",title:"Clear this sketch"});this.controls.appendChild(this.clearControl);this.showThumbsControl=d.util.makeElement("button",{"class":"vs-show-thumbnails-control",title:"Show all sketches"});
this.controls.appendChild(this.showThumbsControl);b.appendChild(this.controls);this.video.nextSibling?this.container.insertBefore(b,this.video.nextSibling):this.container.appendChild(b);this.inactive=true;this.video.readyState>0&&this.sketchpad.setAspectRatio(this.video.videoWidth/this.video.videoHeight,true);this.video.addEventListener("loadedmetadata",this.onVideoMetaDataLoaded.bind(this),false);this.video.addEventListener("play",this.onVideoPlay.bind(this),false);this.video.addEventListener("seeking",
this.onVideoSeeking.bind(this),false);h.addEventListener("resize",this.onWindowResize.bind(this),false);this.pencilControl.addEventListener("click",this.onPencilControlClick.bind(this),false);this.video.addEventListener("click",this.onPencilControlClick.bind(this),false);this.eraserControl.addEventListener("click",this.onEraserControlClick.bind(this),false);this.clearControl.addEventListener("click",this.onClearControlClick.bind(this),false);this.showThumbsControl.addEventListener("click",this.onShowThumbsControlClick.bind(this),
false);d.util.delegate(this.pencilStyles,"div","click",this.onPencilStylesClickDelegate.bind(this));this.onSketchPadMouseMove=this.onSketchPadMouseMove.bind(this);this.onSketchPadMouseOver=this.onSketchPadMouseOver.bind(this);this.onDocumentMouseUp=this.onDocumentMouseUp.bind(this);this.sketchpad.container.addEventListener("mousedown",this.onSketchPadMouseDown.bind(this),false);this.sketchpad.container.addEventListener("contextmenu",this.onSketchPadContextMenu,false)};d.Editor.prototype={createSketch:function(){var a=
new d.Sketch(this.video);this.sketches.push(a);this.createThumbnailFromSketch(a);this.editSketch(a)},editSketch:function(a){this.video.pause();this.seekingFrame=true;this.video.currentTime=a.timestamp;this.sketchpad.attachSketch(a);this.sketch=a;if(this.inactive)this.drawing=true},removeSketch:function(a){this.sketches.splice(this.sketches.indexOf(a),1);if(this.sketchpad.detachSketch(a)){this.inactive=true;delete this.sketch}this.sketches.length||this.container.classList.remove("vs-showing-thumbnails")},
createThumbnailFromSketch:function(a){a=new d.Thumbnail({parent:this.thumbnails,sketch:a,aspectRatio:this.video.videoWidth/this.video.videoHeight});a.bind("select",this.editSketch);a.bind("remove",this.removeSketch)},getPencilStyles:function(){var a=this.pencilStyles.querySelector('.selected[data-group="color"]'),b=this.pencilStyles.querySelector('.selected[data-group="width"]');return{color:a.getAttribute("data-value"),width:parseInt(b.getAttribute("data-value"),10)}},onVideoMetaDataLoaded:function(){this.sketchpad.setAspectRatio(this.video.videoWidth/
this.video.videoHeight,true)},onVideoPlay:function(){this.inactive=true},onVideoSeeking:function(){if(!this.seekingFrame)this.inactive=true;this.seekingFrame=false},onWindowResize:function(){this.video.readyState>0&&setTimeout(this.sketchpad.resizeAndCenter,0)},onPencilControlClick:function(){if(this.inactive){this.video.pause();this.createSketch()}this.drawing=true},onEraserControlClick:function(){this.erasing=this.erasing||this.drawing},onClearControlClick:function(){this.sketch.clear()},onShowThumbsControlClick:function(){this.container.classList.toggle("vs-showing-thumbnails")},
onPencilStylesClickDelegate:function(a){a=a.target;this.pencilStyles.querySelector('.selected[data-group="'+a.getAttribute("data-group")+'"]').classList.remove("selected");a.classList.add("selected")},onSketchPadMouseDown:function(a){var b=d.util.localCoordinates(a),c=a.which===3;this.mouseDown=true;a.preventDefault();this.erasing=this.erasing||this.drawing&&c;if(this.drawing){this.sketch.createPath(this.getPencilStyles());this.sketch.addPointToLastPath(b)}else this.erasing&&this.sketch.removePathsCloseToPoints(b);
this.lastLocalCoordinates=b;document.addEventListener("mouseup",this.onDocumentMouseUp,false);this.sketchpad.container.addEventListener("mousemove",this.onSketchPadMouseMove,false);this.sketchpad.container.addEventListener("mouseover",this.onSketchPadMouseOver,false)},onSketchPadMouseMove:function(a){a=d.util.localCoordinates(a);if(this.drawing)this.sketch.addPointToLastPath(a);else this.erasing&&this.sketch.removePathsCloseToPoints(a,this.lastLocalCoordinates);this.lastLocalCoordinates=a},onSketchPadMouseOver:function(a){a=
d.util.localCoordinates(a);if(this.drawing){this.sketch.createPath(this.getPencilStyles());this.sketch.addPointToLastPath(a)}this.localCoordinates=a},onDocumentMouseUp:function(a){this.mouseDown=false;a.preventDefault();this.drawing=this.drawing||this.erasing&&a.which===3;this.sketchpad.renderPaths();document.removeEventListener("mouseup",this.onDocumentMouseUp,false);this.sketchpad.container.removeEventListener("mousemove",this.onSketchPadMouseMove,false);this.sketchpad.container.removeEventListener("mouseover",
this.onSketchPadMouseOver,false)},onSketchPadContextMenu:function(a){a.preventDefault()}};d.Editor.states=["drawing","erasing","inactive"];d.Editor.states.forEach(function(a){Object.defineProperty(d.Editor.prototype,a,{get:function(){return this.state===a},set:function(b){if(b){this.container.classList.remove("vs-"+this.state);this.container.classList.add("vs-"+a);this.state=a}else if(this.state===a)this.inactive=true}})});d.setup=function(a){return new d.Editor(a)}})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Path=function(a){this.points=[];this.color=a.color;this.width=a.width};d.Path.prototype={addPoint:function(a){this.points.push(a);return this},isCloseToPoints:function(a,b){var c=this.points.length,f,e;if(this.points.length===1)return d.Path.pointDistance(this.points[0],a)<0.02;for(;(f=this.points[--c])&&(e=this.points[c-1]);)if(d.Path.pointDistance(f,a)<0.02)return true;else if(b&&d.Path.segmentsIntersect(a,b,f,e))return true;return false}};
d.util.makeEventSource(d.Path);d.Path.pointDistance=function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))};d.Path.segmentsIntersect=function(a,b,c,f){var e,g;e=(a.x-b.x)*(f.y-b.y)-(a.y-b.y)*(f.x-b.x);e/=(a.y-b.y)*(c.x-f.x)-(a.x-b.x)*(c.y-f.y);g=(c.x-f.x)*(f.y-b.y)-(c.y-f.y)*(f.x-b.x);g/=(a.y-b.y)*(c.x-f.x)-(a.x-b.x)*(c.y-f.y);return e>=0&&e<=1&&g>=0&&g<=1};d.Path.styles=[];d.Path.styles.push({group:"color",label:"White",value:"#fff",isDefault:true});d.Path.styles.push({group:"color",
label:"Red",value:"#ff0000"});d.Path.styles.push({group:"width",label:"Thick",value:12,isDefault:true});d.Path.styles.push({group:"width",label:"Thin",value:4})})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Sketch=function(a){this.paths=[];if(a){this.timestamp=a.currentTime;this.capture(a)}};d.Sketch.prototype={capture:function(a){this.timestamp=a.currentTime;this.frame=d.util.makeElement("canvas");this.frame.width=a.videoWidth;this.frame.height=a.videoHeight;this.frame.getContext("2d").drawImage(a,0,0)},createPath:function(a){this.lastPath=new d.Path(a);this.paths.push(this.lastPath);return this.lastPath},addPointToLastPath:function(a){this.lastPath.addPoint(a);
this.trigger("pathaddpoint",this.lastPath,a)},removePathsCloseToPoints:function(a,b){for(var c=[],f=this.paths.length,e;e=this.paths[--f];)e.isCloseToPoints(a,b)||c.push(e);if(c.length!==this.paths.length){this.paths=c;this.trigger("pathremove")}},clear:function(){this.paths=[];this.trigger("pathremove")}};d.util.makeEventSource(d.Sketch)})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Renderer=function(a){this.renderFrame=this.renderFrame.bind(this);this.renderPaths=this.renderPaths.bind(this);this.renderPathPoint=this.renderPathPoint.bind(this);this.container=d.util.makeElement("div",{"class":a["class"]||"vs-renderer"});this.backCanvas=d.util.makeElement("canvas",{"class":"vs-back-canvas"});this.container.appendChild(this.backCanvas);this.frontCanvas=d.util.makeElement("canvas",{"class":"vs-front-canvas"});this.container.appendChild(this.frontCanvas);
a.parent.appendChild(this.container);this.frontContext=this.frontCanvas.getContext("2d");d.Renderer.normalizeContext(this.frontContext);this.backContext=this.backCanvas.getContext("2d");this.setCanvasSize(a.width||300,a.height||150);a.sketch&&this.attachSketch(a.sketch)};d.Renderer.prototype={setCanvasSize:function(a,b){this.frontCanvas.width=this.backCanvas.width=this.width=a;this.frontCanvas.height=this.backCanvas.height=this.height=b;d.Renderer.normalizeContext(this.frontContext);this.sketch&&
this.renderAll()},setContainerSize:function(a,b){this.container.style.width=a+"px";this.container.style.height=b+"px"},setContainerOffset:function(a,b){this.container.style.left=a+"px";this.container.style.top=b+"px"},attachSketch:function(a){this.sketch&&this.detachSketch(this.sketch);this.sketch=a;this.sketch.bind("pathremove",this.renderPaths);this.sketch.bind("pathaddpoint",this.renderPathPoint);this.renderAll()},detachSketch:function(a){var b=false;if(a===this.sketch){this.sketch.unbind("pathremove",
this.renderPaths);this.sketch.unbind("pathaddpoint",this.renderPathPoint);delete this.sketch;b=true}return b},renderAll:function(){this.renderPaths();this.renderFrame()},renderFrame:function(){var a=this.sketch.frame;try{this.backContext.drawImage(a,0,0,a.width,a.height,0,0,this.width,this.height)}catch(b){}},renderPaths:function(){this.clear();this.sketch.paths.forEach(this.renderPath,this)},renderPath:function(a){var b=a.points,c=b.length,f=d.Renderer.getControlPoints,e=0,g;this.setPathStyle(a);
if(a.points.length<3)this.renderPathPoint(a,b[c-1]);else{this.frontContext.beginPath();a=b[0];this.frontContext.normalizedMoveTo(a.x,a.y);for(e=1;e<c-1;e++){a=b[e];g=f(b[e-1],a,b[e+1]);this.frontContext.normalizedQuadraticCurveTo(g.p1.x,g.p1.y,a.x,a.y)}this.frontContext.normalizedQuadraticCurveTo(g.p2.x,g.p2.y,b[c-1].x,b[c-1].y);this.frontContext.stroke()}},renderPathPoint:function(a,b){var c=a.points[a.points.indexOf(b)-1]||{x:b.x*1.001,y:b.y*1.001};this.setPathStyle(a);this.frontContext.beginPath();
this.frontContext.normalizedMoveTo(c.x,c.y);this.frontContext.normalizedLineTo(b.x,b.y);this.frontContext.stroke()},setPathStyle:function(a){this.frontContext.strokeStyle=a.color||"#fff";this.frontContext.lineWidth=a.width/1E3*this.frontCanvas.width;this.frontContext.lineCap="round";this.frontContext.lineJoin="round"},clear:function(){this.frontContext.clearRect(0,0,this.frontCanvas.width,this.frontCanvas.height)},setAspectRatio:function(a,b){if(this.container&&this.container.nodeType){var c;this.aspectRatio=
a;if(b){this.resizeAndCenter=this.resizeAndCenter.bind(this);this.resizeAndCenter()}else{c=d.util.makeElement("img");c.src=d.util.makeElement("canvas",{width:50,height:50/a}).toDataURL();this.container.appendChild(c)}}},resizeAndCenter:function(){if(!(!this.container||!this.container.nodeType||!this.container.parentNode)){var a=this.container.parentNode.getBoundingClientRect(),b={top:0,left:0,width:0,height:0};if(this.aspectRatio>a.width/a.height){b.top=(a.height-a.width/this.aspectRatio)/2;b.width=
a.width;b.height=a.width/this.aspectRatio}else{b.left=(a.width-a.height*this.aspectRatio)/2;b.width=a.height*this.aspectRatio;b.height=a.height}this.setCanvasSize(b.width,b.height);this.setContainerSize(b.width,b.height);this.setContainerOffset(b.left,b.top)}}};d.Renderer.normalizeContext=function(a){var b=a.canvas.width,c=a.canvas.height;a.normalizedMoveTo=function(f,e){a.moveTo(f*b,e*c)};a.normalizedLineTo=function(f,e){a.lineTo(f*b,e*c)};a.normalizedQuadraticCurveTo=function(f,e,g,j){a.quadraticCurveTo(f*
b,e*c,g*b,j*c)}};d.Renderer.getControlPoints=function(a,b,c){var f=Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2)),e=Math.sqrt(Math.pow(c.x-b.x,2)+Math.pow(c.y-b.y,2)),g=0.5*f/(f+e);f=0.5*e/(f+e);return{p1:{x:b.x-g*(c.x-a.x),y:b.y-g*(c.y-a.y)},p2:{x:b.x+f*(c.x-a.x),y:b.y+f*(c.y-a.y)}}}})(this);
(function(h){var d=h.videosketch||(h.videosketch={});d.Thumbnail=function(a){this.parent=a.parent;this.container=d.util.makeElement("li",{"class":"vs-thumbnail selected"});this.select();this.sketchpad=new d.Renderer({parent:this.container,width:300,height:300/a.aspectRatio,sketch:a.sketch});this.sketchpad.setAspectRatio(a.aspectRatio);this.removeControl=d.util.makeElement("button",{"class":"vs-remove-control",title:"Remove this sketch"});this.container.appendChild(this.removeControl);this.parent.appendChild(this.container);
this.container.addEventListener("click",this.onContainerClick.bind(this),false);this.removeControl.addEventListener("click",this.onRemoveControlClick.bind(this),false)};d.Thumbnail.prototype={onContainerClick:function(){this.select();this.trigger("select",this.sketchpad.sketch)},onRemoveControlClick:function(a){a.stopPropagation();this.remove();this.trigger("remove",this.sketchpad.sketch)},select:function(){var a=this.parent.querySelector(".vs-thumbnail.selected");a&&a.classList.remove("selected");
this.container.classList.add("selected")},remove:function(){this.sketchpad.detachSketch();this.parent.removeChild(this.container)}};d.util.makeEventSource(d.Thumbnail)})(this);